# Aquarium Manager Backend

A Java-based REST API for managing aquarium systems, built with Jakarta EE, Jersey, and Hibernate.

## Features

- **Aquarium Management**: Create, read, update, and delete aquariums
- **Inhabitant Tracking**: Manage fish and other aquatic life
- **Accessory Management**: Track filters, heaters, lights, and other equipment
- **Ornament Catalog**: Manage decorative elements
- **User Authentication**: JWT-based authentication system
- **Database Integration**: PostgreSQL with Hibernate ORM
- **Health Monitoring**: Built-in health check endpoints

## Technology Stack

- **Java 17**
- **Jakarta EE 10**
- **Jersey 3.1.3** (JAX-RS implementation)
- **Hibernate 6.2.7** (JPA implementation)
- **PostgreSQL** (Database)
- **HikariCP** (Connection pooling)
- **JWT** (Authentication)
- **Maven** (Build tool)
- **Docker** (Containerization)

## Quick Start

### Prerequisites

- Java 17 or higher
- Maven 3.6+
- PostgreSQL database
- Docker (optional)

### Local Development

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd aquarium-manager-backend
   ```

2. **Set up environment variables**
   ```bash
   export DB_HOST=localhost
   export DB_PORT=5432
   export DB_NAME=aquariumdb
   export DB_USER=postgres
   export DB_PASSWORD=your_password
   export JWT_SECRET=your_jwt_secret_key
   export HIBERNATE_HBM2DDL=update
   ```

3. **Build and run**
   ```bash
   mvn clean package
   java -jar target/dependency/webapp-runner.jar --port 8080 target/aquarium-api.war
   ```
   
   **Note**: For production deployments with environment variables, use:
   ```bash
   java -Dserver.port=$PORT -jar target/dependency/webapp-runner.jar --port $PORT target/aquarium-api.war
   ```

4. **Access the API**
   - API Base URL: `http://localhost:8080/api`
   - Health Check: `http://localhost:8080/api/health`
   - API Documentation: See `API_DOCUMENTATION.md`

## Railway Deployment

### Automatic Deployment

1. **Connect your GitHub repository to Railway**
   - Go to [Railway](https://railway.app)
   - Create a new project
   - Connect your GitHub repository

2. **Add PostgreSQL Database Service** (REQUIRED)
   - In your Railway project dashboard, click the `+ New` button
   - Select `Database` → `PostgreSQL`
   - Wait for the database service to deploy completely

3. **Deploy your backend service**
   - Click `+ New` → `GitHub Repo`
   - Select your repository
   - Railway will automatically detect the Dockerfile and deploy

4. **Configure Database Connection**
   - Go to your backend service settings
   - Navigate to the `Variables` tab
   - Add: `DATABASE_URL` = `${{Postgres.DATABASE_URL}}`
   - Your service will automatically redeploy

5. **Verify Deployment**
   - Check that the health check passes at `/api/health`
   - Your API will be available at the generated Railway URL

### Manual Environment Variables

Railway automatically provides these database variables when you add a PostgreSQL service:
- `DATABASE_URL` - Complete PostgreSQL connection string (recommended)
- `PGHOST` - Database host
- `PGPORT` - Database port  
- `PGUSER` - Database username
- `PGPASSWORD` - Database password
- `PGDATABASE` - Database name

### Required Environment Variables

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `DATABASE_URL` | PostgreSQL connection URL | - | Yes (auto-set by Railway) |
| `JWT_SECRET` | JWT secret key for token signing | - | Yes (auto-generated by Railway) |
| `HIBERNATE_HBM2DDL` | Hibernate DDL auto mode | update | No |

## Environment Variables

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `DATABASE_URL` | PostgreSQL connection URL | - | Yes (auto-set by Railway) |
| `DB_HOST` | Database host | localhost | No (if DATABASE_URL is set) |
| `DB_PORT` | Database port | 5432 | No |
| `DB_NAME` | Database name | aquariumdb | No |
| `DB_USER` | Database username | postgres | No |
| `DB_PASSWORD` | Database password | postgres | No |
| `JWT_SECRET` | JWT signing secret | - | Yes |
| `JWT_EXPIRATION` | JWT expiration time (ms) | 86400000 | No |
| `HIBERNATE_HBM2DDL` | Hibernate DDL mode | update | No |
| `PORT` | Application port | 8080 | No (auto-set by Railway) |

## API Endpoints

### Authentication
- `POST /api/auth/register` - Register a new user
- `POST /api/auth/login` - Login user

### Aquariums
- `GET /api/aquariums` - Get all aquariums
- `POST /api/aquariums` - Create aquarium
- `GET /api/aquariums/{id}` - Get aquarium by ID
- `PUT /api/aquariums/{id}` - Update aquarium
- `DELETE /api/aquariums/{id}` - Delete aquarium

### Health Check
- `GET /api/health` - Application health status

For complete API documentation, see [API_DOCUMENTATION.md](API_DOCUMENTATION.md).

## Docker

### Build and run with Docker

```bash
# Build the image
docker build -t aquarium-api .

# Run the container
docker run -p 8080:8080 \
  -e DATABASE_URL=postgresql://user:password@host:5432/database \
  -e JWT_SECRET=your_secret \
  aquarium-api
```

### Docker Compose

```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/aquariumdb
      - JWT_SECRET=your_secret_key
    depends_on:
      - db
  
  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=aquariumdb
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
```

## Development

### Project Structure

```
src/
├── main/
│   ├── java/
│   │   └── nl/hu/bep/
│   │       ├── application/     # Service layer
│   │       ├── config/          # Configuration classes
│   │       ├── data/            # Repository layer
│   │       ├── domain/          # Domain entities
│   │       ├── presentation/    # REST controllers and DTOs
│   │       └── security/        # Authentication and authorization
│   ├── resources/
│   │   └── META-INF/
│   │       └── persistence.xml  # JPA configuration
│   └── webapp/
│       └── WEB-INF/
│           └── web.xml          # Web application configuration
└── test/                        # Test classes
```

### Building

```bash
# Clean and compile
mvn clean compile

# Run tests
mvn test

# Package WAR file
mvn package

# Skip tests during packaging
mvn package -DskipTests
```

### Database Migrations

The application uses Hibernate's automatic schema generation. Set `HIBERNATE_HBM2DDL` to:
- `create` - Drop and recreate schema
- `create-drop` - Create schema, drop on shutdown
- `update` - Update schema (recommended for development)
- `validate` - Validate schema without changes
- `none` - No automatic schema management

## Troubleshooting

### Railway Health Check Failures

If your Railway deployment shows "Service Unavailable" during health checks, the most common cause is a missing PostgreSQL database service.

#### Symptoms
- Build succeeds but health check fails repeatedly
- Error: "Attempt #X failed with service unavailable"
- Application logs show database connection errors

#### Solution
1. **Add PostgreSQL Database Service**:
   - In your Railway project dashboard, click the `+ New` button
   - Select `Database` → `PostgreSQL`
   - Wait for the database to deploy

2. **Configure Database Reference Variables**:
   - Go to your backend service settings
   - Navigate to the `Variables` tab
   - Add a new variable: `DATABASE_URL` with value `${{Postgres.DATABASE_URL}}`
   - Railway will automatically populate this with the correct database connection string

3. **Redeploy Your Service**:
   - Your backend service will automatically redeploy with the new database connection
   - The health check should now pass

#### Graceful Degradation
The application is designed to start even without database connectivity:
- **Basic health check** (`/api/health/basic`) will work without database
- **Full health check** (`/api/health`) will show database status
- **Database-dependent operations** will fail gracefully with appropriate error messages
- **Application logs** will show database initialization status

#### Alternative: Manual Environment Variables
If you prefer individual database variables instead of `DATABASE_URL`:
```
DB_HOST=${{Postgres.PGHOST}}
DB_PORT=${{Postgres.PGPORT}}
DB_NAME=${{Postgres.PGDATABASE}}
DB_USER=${{Postgres.PGUSER}}
DB_PASSWORD=${{Postgres.PGPASSWORD}}
```

### Other Common Issues

1. **Database Connection Failed**
   - Verify PostgreSQL is running
   - Check DATABASE_URL or individual DB_* environment variables
   - Ensure database exists and user has proper permissions

2. **Port Configuration Issues**
   - **Error**: `"--port": couldn't convert "$PORT" to an integer`
   - **Cause**: Environment variable not properly expanded in command line
   - **Solution**: Ensure commands use shell expansion: `sh -c 'command with $PORT'`
   - **Files to check**: `railway.json`, `Dockerfile`, `Procfile`

3. **Application Won't Start**
   - Check Java version (requires Java 17+)
   - Verify all required environment variables are set
   - Check application logs for specific error messages

4. **Authentication Issues**
   - Ensure JWT_SECRET is set and consistent
   - Check token expiration settings
   - Verify user registration/login endpoints

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Submit a pull request

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.